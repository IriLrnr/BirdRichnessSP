---
title: "Assessing the Impact of Urban Infrastructure on Bird Biodiversity"
author: "Bianca Neves & Irina Lerner"
date: "30/08/24"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: paper
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(dplyr)
library(PerformanceAnalytics) # for correlation matrix
library(tidyr) # for organized code
library(sf, sp) # for reading shp and ploting
library(spdep)
library(ggeffects)
library(spaMM)
library(mgcv)
library(randomForest)
library(pdp)
library(glmnet)
library(vegan)
library(pscl)
library(gridExtra)

custom_theme <- theme_minimal() +
                theme(text = element_text(size = 12),
                      plot.title = element_blank(),
                      panel.grid.major = element_blank(),
                      panel.grid.minor = element_blank())
```

# Data 4km²

This is a $4km^2$ grid over the urban area of the city of São Paulo

```{r data, include=FALSE}
# sum of species
#shp <- st_read("Z:/Bianca/eBird/Data/1km_urb_f1km/richness_effort_v16_total_1km_urb_f1km_30min_10spp.shp")
shp <- st_read("C:/Users/Bianca/Documents/USP/Projeto/eBird/Data/2km/richness_effort_v16_total_2km_urb_f2.5km_30min_10spp.shp")
cdata <- shp

# Rename columns
cdata <- cdata %>% 
  rename(
    lpi_f = X1_lpi,
    lpi_h = X2_lpi,
    ed_f = X1_ed,
    ed_h = X2_ed,
    contig_f = X1_contig,
    contig_h = X2_contig,
    plant_f = X1_pland,
    pland_h = X2_pland,
    nlsi_f = X1_nlsi,
    nlsi_h = X2_nlsi,
    te_f = X1_te,
    te_h = X2_te,
    np_f = X1_np,
    np_h = X2_np,
    area_mn_f = X1_area_mn,
    area_mn_h = X2_area_mn,
    area_mn_tot = area_mn_to)

cdata <- cdata %>%
  mutate(across(everything(), ~ replace_na(., 0)))
```

# Variables

```{r, include = FALSE}
# List of variables
response <- "richness"

structure <- c("SUVI", "SVI", "SGVI", "SEVIn", "shdi")
dynamics <- c("effort", "pop", "Wdistance", "Gdistance", "Bvol", "Bheight_me", 
              "Vvol", "Vheight_me")
composition <- c("prop_veg", "pland_tot")
configuration <- c("shdi", "lpi_tot", "ed_tot", "contig_mn_", "nlsi_tot", "te_tot", 
                   "np_tot", "area_mn_tot")
predictors <- c(structure, dynamics, composition, configuration)

cdata$centx <- st_coordinates(st_centroid(cdata))[, 1]
cdata$centy <- st_coordinates(st_centroid(cdata))[, 2]
```

## Correlation among variables
There is high correlations among variables
```{r, echo = FALSE}
# Full set of variables
all_vars <- c("richness", structure, dynamics, composition, configuration)

# All
cor_mat_structure <- as.data.frame(cdata)[all_vars]
suppressWarnings(chart.Correlation(cor_mat_structure, histogram=TRUE, pch=16, method = "pearson"))
```

### Structure variables
```{r, echo = FALSE}
# Create correlation matrices for each group
# Structure
cor_mat_structure <- as.data.frame(cdata)[all_vars][c("richness", structure)]
suppressWarnings(chart.Correlation(cor_mat_structure, histogram=TRUE, pch=16, method = "pearson"))
```

### Composition variables
```{r, echo = FALSE}
# Composition
cor_mat_composition <- as.data.frame(cdata)[all_vars][c("richness", composition)]
suppressWarnings(chart.Correlation(cor_mat_composition, histogram=TRUE, pch=16, method = "pearson"))
```
### Configuration variables
```{r, echo = FALSE}
# Configuration
cor_mat_configuration <- as.data.frame(cdata)[all_vars][c("richness", configuration)]
suppressWarnings(chart.Correlation(cor_mat_configuration, histogram=TRUE, pch=16, method = "pearson"))
```
### Dynamics variables
```{r, echo = FALSE}
# Dynamics
cor_mat_dynamics <- as.data.frame(cdata)[all_vars][c("richness", dynamics)]
suppressWarnings(chart.Correlation(cor_mat_dynamics, histogram=TRUE, pch=16, method = "pearson"))
```

## Association between richness and variables
```{r, echo = FALSE, warning=FALSE, message=FALSE}
# Create a new table with NA values replaced by 0 in the specified predictor columns
cdata1 <- cdata %>%
  mutate(across(all_of(c(structure, dynamics, composition, configuration)), ~ replace_na(., 0)))

# Reshape the data to long format with only 'value' and 'variable'
cdata_long <- cdata1 %>%
  select(richness, all_of(c(structure, dynamics, composition, configuration))) %>%
  pivot_longer(
    cols = c(structure, dynamics, composition, configuration),
    names_to = "variable",
    values_to = "value"
  )

# Create faceted plot for the 'structure' group
plot_structure <- ggplot(cdata_long %>% filter(variable %in% structure), aes(x = value, y = richness)) + 
  geom_point(alpha = 0.7, color = "black") + 
  geom_smooth(method = "loess", color = "blue", fill = "blue", alpha = 0.1) +
  facet_wrap(~ variable, scales = "free_x", ncol = 3) + # Adjust the number of columns as needed
  labs(x = "Value", y = "Richness") +
  theme_classic() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 16, face = "bold")
  ) +
  ggtitle("Richness vs. Structure Predictors")

# Create faceted plot for the 'dynamics' group
plot_dynamics <- ggplot(cdata_long %>% filter(variable %in% dynamics), aes(x = value, y = richness)) + 
  geom_point(alpha = 0.7, color = "black") + 
  geom_smooth(method = "loess", color = "blue", fill = "blue", alpha = 0.1) +
  facet_wrap(~ variable, scales = "free_x", ncol = 4) + # Adjust the number of columns as needed
  labs(x = "Value", y = "Richness") +
  theme_classic() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 16, face = "bold")
  ) +
  ggtitle("Richness vs. Dynamics Predictors")

# Create faceted plot for the 'composition' group
plot_composition <- ggplot(cdata_long %>% filter(variable %in% composition), aes(x = value, y = richness)) + 
  geom_point(alpha = 0.7, color = "black") + 
  geom_smooth(method = "loess", color = "blue", fill = "blue", alpha = 0.1) +
  facet_wrap(~ variable, scales = "free_x", ncol = 2) + # Adjust the number of columns as needed
  labs(x = "Value", y = "Richness") +
  theme_classic() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 16, face = "bold")
  ) +
  ggtitle("Richness vs. Composition Predictors")

# Create faceted plot for the 'configuration' group with limited y-axis
plot_configuration <- ggplot(cdata_long %>% filter(variable %in% configuration), aes(x = value, y = richness)) + 
  geom_point(alpha = 0.7, color = "black") + 
  geom_smooth(method = "loess", color = "blue", fill = "blue", alpha = 0.1) +
  facet_wrap(~ variable, scales = "free_x", ncol = 4) + # Adjust the number of columns as needed
  labs(x = "Value", y = "Richness") +
  theme_classic() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 16, face = "bold")
  ) +
  ggtitle("Richness vs. Configuration Predictors") +
  coord_cartesian(ylim = c(0, max(cdata$richness, na.rm = TRUE))) # Limiting the y-axis

# Print the plots
print(plot_structure)
print(plot_dynamics)
print(plot_composition)
print(plot_configuration)
```

# Spatial
Testing for spatial correlation
```{r, echo=FALSE, warning=FALSE}
coords <- st_centroid(cdata)
nb <- poly2nb(cdata)
lw <- nb2listw(nb, style="W", zero.policy=TRUE)
moran.mc(cdata$richness, lw, nsim = 999)
```
We see that there is a small spatial correlation

Lets check the spatial distribuition of richness

```{r, echo=FALSE, warning=FALSE}
ggplot(data = cdata) +
  geom_sf(aes(fill = richness), color = NA) +
  scale_fill_viridis_c(direction = -1) +
  custom_theme
```


# Lasso e ridge selection
We use lasso and ridge regression, a method that penalizes variables for multicolinearity and selects significant variables.

```{r, echo=FALSE, warning=FALSE}
X <- as.matrix(as.data.frame(cdata)[, predictors])
richness <- cdata$richness

lasso_model <- cv.glmnet(X, richness, family = "poisson", alpha = 1)
ridge_model <- cv.glmnet(X, richness, family = "poisson", alpha = 0)

lasso_coefs <- coef(lasso_model, s = "lambda.min")
ridge_coefs <- coef(ridge_model, s = "lambda.min")

# Prepare data for plotting
variable_names <- rownames(lasso_coefs)[-1]  # Exclude intercept
lasso_effect_sizes <- lasso_coefs[-1, 1]  # Exclude intercept
ridge_effect_sizes <- ridge_coefs[-1, 1]  # Exclude intercept

# Create a data frame
effect_sizes_df <- data.frame(
  Variable = variable_names,
  Lasso = lasso_effect_sizes,
  Ridge = ridge_effect_sizes
)

# Reshape data for ggplot2
effect_sizes_long <- gather(effect_sizes_df, key = "Model", value = "EffectSize", -Variable)

# Create the plot
ggplot(effect_sizes_long, aes(x = EffectSize, y = Variable, color = Model)) +
  geom_point(size = 3) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey") +
  labs(x = "Effect Size", y = "") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 10))

# Fit a model (Lasso or Ridge) with cross-validation to find the best lambda
cv_fit <- cv.glmnet(X, richness, alpha = 1)  # alpha = 1 for Lasso, 0 for Ridge

# Extract the best lambda value from cross-validation
best_lambda <- cv_fit$lambda.min

# Fit the final model using the best lambda
best_model <- glmnet(X, richness, alpha = 1, lambda = best_lambda)

# Predict on the training data using the best model
richness_pred <- predict(best_model, newx = X)

# Calculate R-squared manually
sst <- sum((richness - mean(richness))^2)  # Total sum of squares
sse <- sum((richness - richness_pred)^2)   # Sum of squared errors
r2 <- 1 - (sse / sst)
cat("R-squared: ", r2, "\n")

# Selected variables
lasso_selected <- variable_names[lasso_coefs[-1, 1] != 0]  
ridge_selected <- variable_names[ridge_coefs[-1, 1] != 0]

cat("Variáveis selecionadas pelo Lasso:\n", lasso_selected, "\n")
cat("Variáveis selecionadas pelo Ridge:\n", ridge_selected, "\n")


```


# GLM

Calculating the AIC for a null model to provide a baseline or reference point for comparison with other models that include predictors.

```{r}
null_model_lm <- lm(richness ~ 1, cdata)
AIC(lm(richness ~ 1, cdata))

null_model_poisson <- glm(richness ~ 1, data = cdata, family = poisson(link = "log"))
AIC(glm(richness ~ 1, data = cdata, family = poisson(link = "log")))
```

Different models for analyzing bird richness in the 1km range

```{r, echo=FALSE, warning=FALSE}
formula <- as.formula(paste("richness ~", paste(predictors, collapse = " + ")))

full_model_glm <- glm(formula, data = cdata, family = poisson(link = "log"))

summary(full_model_glm)


# Get the summary of the model
model_summary_glm <- summary(full_model_glm)
coefficients <- model_summary_glm$coefficients[, "Estimate"]
standard_errors <- model_summary_glm$coefficients[, "Std. Error"]

# Combine them into a data frame
effects_df <- data.frame(
  Variable = names(coefficients),
  EffectSize = coefficients,
  StdError = standard_errors
)

# Create the plot
ggplot(effects_df[-1,], aes(x = EffectSize, y = Variable)) +
  geom_point(size = 3) +
  geom_vline(xintercept = 0, colour="red", linetype = "dashed") +
  geom_errorbarh(aes(xmin = EffectSize - StdError, xmax = EffectSize + StdError), height = 0.2) +
  labs(x = "Effect Size", y = "") +
  theme_bw()


```
Stepwise 

```{r, echo=FALSE, warning=FALSE}
# Realizar a seleção de variáveis
stepwise_model <- step(full_model_glm, direction = "both", trace = TRUE)

# Visualizar o resumo do modelo selecionado
summary(stepwise_model)

```

```{r, echo=FALSE, warning=FALSE}
selected <- glm(formula = richness ~ SUVI + SVI + SGVI + SEVIn + shdi + effort + 
    pop + Gdistance + Bheight_me + Vheight_me + prop_veg + pland_tot + 
    lpi_tot + ed_tot + nlsi_tot + np_tot, family = poisson(link = "log"), 
    data = cdata)
summary(selected)

# Ajuste o modelo nulo
null_model <- glm(richness ~ 1, family = poisson(link = "log"), data = cdata)

# Log-likelihood do modelo completo
logLik_full <- logLik(selected)

# Log-likelihood do modelo nulo
logLik_null <- logLik(null_model)

# Calcule o pseudo R^2 de McFadden
pseudo_r2 <- 1 - (logLik_full / logLik_null)
print(pseudo_r2)

# Instale e carregue o pacote pscl
install.packages("pscl")
library(pscl)

# Calcule o pseudo R^2 usando o pacote pscl
pseudo_r2_values <- pR2(selected)
print(pseudo_r2_values)

```

```{r, echo=FALSE, warning=FALSE}
sh_sp_model <- glm(richness ~ SVI + effort + SEVIn, data = cdata, family = poisson(link = "log"))

summary(sh_sp_model)


# Get the summary of the model
sh_sp_model_summary <- summary(sh_sp_model)
sh_sp_coefficients <- sh_sp_model_summary$coefficients[, "Estimate"]
sh_sp_standard_errors <- sh_sp_model_summary$coefficients[, "Std. Error"]

# Combine them into a data frame
sh_sp_effects_df <- data.frame(
  Variable = names(sh_sp_coefficients),
  EffectSize = sh_sp_coefficients,
  StdError = sh_sp_standard_errors
)

# Create the plot
ggplot(sh_sp_effects_df[-1,], aes(x = EffectSize, y = Variable)) +
  geom_point(size = 3) +
  geom_vline(xintercept = 0, colour="red", linetype = "dashed") +
  geom_errorbarh(aes(xmin = EffectSize - StdError, xmax = EffectSize + StdError), height = 0.2) +
  labs(x = "Effect Size", y = "") +
  theme_bw()
```
# GAM
```{r, echo=FALSE, warning=FALSE}
# Variáveis selecionadas pelo Lasso
lasso_vars <- c("SEVIn", "shdi")

# Criar fórmula para o modelo GAM
lasso_formula <- as.formula(paste("richness ~", paste(lasso_vars, collapse = " + ")))

# Ajustar o modelo GAM usando as variáveis selecionadas pelo Lasso
gam_lasso <- gam(lasso_formula, data = cdata, family = poisson(link = "log"))

# Resumo do modelo
summary(gam_lasso)
```

```{r, echo=FALSE, warning=FALSE}
# Variáveis selecionadas pelo Ridge
ridge_vars <- c("SUVI", "SVI", "SGVI", "SEVIn", "shdi", "prop_veg", "nlsi_tot")

# Criar fórmula para o modelo GAM
ridge_formula <- as.formula(paste("richness ~", paste(ridge_vars, collapse = " + ")))

# Ajustar o modelo GAM usando as variáveis selecionadas pelo Ridge
gam_ridge <- gam(ridge_formula, data = cdata, family = poisson(link = "log"))

# Resumo do modelo
summary(gam_ridge)

```

# Random forest

```{r, echo=FALSE, warning=FALSE}
data_rf <- data.frame(cdata[, c(response, predictors)], 
                      coord_x = cdata$centx, 
                      coord_y = cdata$centy)

data_rf_clean <- data_rf %>%
  select(-geometry) %>%
  na.omit()
data_rf_clean <- as.data.frame(data_rf_clean)

# Fit Random Forest model
rf_model <- randomForest(richness ~ ., data = data_rf_clean, importance = TRUE)

# Summarize the model
print(rf_model)
# Check variable importance
importance <- rf_model$importance
print(importance)

# Plot variable importance
varImpPlot(rf_model)

# Create a plot for variable importance
importance_df <- data.frame(
  Variable = rownames(importance),
  Importance = importance[,1]
)

ggplot(importance_df, aes(x = reorder(Variable, Importance), y = Importance)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  labs(title = 'Variable Importance', x = 'Variables', y = 'Importance') +
  custom_theme
```


### Partial dependence plot
```{r, echo=FALSE, warning=FALSE}
# Partial Dependence Plot
pdp_lpi_tot <- partial(rf_model, pred.var = "lpi_tot", plot = TRUE, rug = TRUE, train = data_rf)
print(pdp_lpi_tot)

pdp_pop <- partial(rf_model, pred.var = "pop", plot = TRUE, rug = TRUE, train = data_rf)
print(pdp_pop)

pdp_sevin <- partial(rf_model, pred.var = "SEVIn", plot = TRUE, rug = TRUE, train = data_rf)
print(pdp_sevin)

pdp_bvol <- partial(rf_model, pred.var = "Bvol", plot = TRUE, rug = TRUE, train = data_rf)
print(pdp_bvol)

pdp_sgvi <- partial(rf_model, pred.var = "SGVI", plot = TRUE, rug = TRUE, train = data_rf)
print(pdp_sgvi)

pdp_area_mn_tot <- partial(rf_model, pred.var = "area_mn_tot", plot = TRUE, rug = TRUE, train = data_rf)
print(pdp_area_mn_tot)

```