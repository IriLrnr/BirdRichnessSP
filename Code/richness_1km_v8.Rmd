---
title: "Assessing the Impact of Urban Infrastructure on Bird Biodiversity"
author: "Bianca Neves, Irina Lerner, Douglas Cirino"
date: "2024-09-11"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: paper
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)       # For data visualization
library(dplyr)         # For data manipulation
library(PerformanceAnalytics) # For correlation matrix
library(tidyr)         # For data tidying
library(sf)            # For handling spatial data
library(sp)            # For handling spatial data
library(spdep)         # For spatial dependence analysis
library(ggeffects)    # For extracting and plotting model effects
library(mgcv)          # For fitting GAMs
library(viridis)       # For color scales
library(patchwork)    # combine plots

custom_theme <- theme_minimal() +
  theme(text = element_text(size = 12),
        plot.title = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

```

# Data 1km²
This is a $1km^2$ grid over the urban area of the city of São Paulo
```{r data, include=FALSE, warning=FALSE}
shp <- st_read("Z:/Bianca/eBird/Data/1km_urb_f1km/richness_effort_v17_total_1km_urb_f1km_30min_10spp.shp")
#shp <- st_read("C:/Users/Bianca/Documents/USP/Projeto/eBird/Data/1km/richness_effort_v16_total_1km_urb_f1km_30min_10spp.shp")
cdata <- shp


## 2. Rename columns
cdata <- cdata %>% 
  rename(
    richness = richnss,
    richness_a = rchnss_,
    effort = effort,
    effort_a = effort_,
    Bheight_m = Bhght_m,
    Bheight_s = Bhght_s,
    Vheight_m = Vhght_m,
    Vheight_s = Vhght_s,
    Wdistance = Wdistnc,
    contig_f = contg_f,
    contig_h = contg_h,
    pland_f = plant_f,
    pland_h = pland_h,
    area_mn_f = ar_mn_f,
    area_mn_h = ar_mn_h,
    prop_veg = prop_vg,
    prop_for = prp_frs,
    prop_wet = prp_wtl,
    prop_grc = prp_grc,
    prop_hrb = prp_hrb,
    landscape_ = lndscp_,
    contig_m_tot = cntg_m_,
    pland_tot = plnd_tt,
    nlsi_tot = nlsi_tt,
    area_m_tot = ar_mn_t,
    Gdistance = Gdistnc,
    geometry = geometry
  )

cdata <- cdata %>%
  mutate(across(everything(), ~ replace_na(., 0))) %>% 
  arrange(id)

cdata$centx <- st_coordinates(st_centroid(cdata))[, 1]
cdata$centy <- st_coordinates(st_centroid(cdata))[, 2]

```

### Correlation between variables
```{r cor, echo=FALSE, warning=FALSE}
## 1. Predictors
predictors <- c("effort", "SVI", "SEVIo", "SUVI", "SGVI", "prop_veg")

## 2. Correlation of variables
cor_mat_structure <- as.data.frame(cdata)[, c("richness", predictors)]
suppressWarnings(chart.Correlation(cor_mat_structure, histogram = TRUE, pch = 16, method = "pearson"))
```

### Association between richness and variables
```{r rich, echo=FALSE, warning=FALSE}
## 3. Association between richness and variables
# Reshape the data to long format with only 'value' and 'variable'
cdata_long <- cdata %>%
  
  select(richness, all_of(predictors)) %>%
  pivot_longer(
    cols = all_of(predictors),
    names_to = "variable",
    values_to = "value"
  )

# Create a faceted plot for the specified predictors
(plot_structure <- ggplot(cdata_long, aes(x = value, y = richness)) + 
    geom_point(alpha = 0.7, color = "black") + 
    geom_smooth(method = "loess", color = "blue", fill = "blue", alpha = 0.1) +
    facet_wrap(~ variable, scales = "free_x", ncol = 2, nrow = 3) +  # Adjusting to 3 rows and 2 columns
    labs(x = "Value", y = "Richness") +
    theme_classic() + 
    theme(
      axis.title = element_text(size = 14),  
      axis.text = element_text(size = 14),
      strip.text = element_text(size = 12, face = "bold"),
      plot.title = element_text(size = 16, face = "bold")
    ) +
    ggtitle("Richness vs. Predictors"))

```

# Spatial correlation
```{r spatial, echo=FALSE, warning=FALSE}
# 1. Testing for spatial correlation
coords <- st_centroid(cdata)
nb <- poly2nb(cdata)
lw <- nb2listw(nb, style="W", zero.policy=TRUE)
moran.mc(cdata$richness, lw, nsim = 999)
# We see that there is a small spatial correlation

# 2. Check the spatial distribuition of richness
(ggplot(data = cdata) +
  geom_sf(aes(fill = richness), color = NA) +
  scale_fill_viridis_c(direction = -1) +
  custom_theme)
```


# Generalized additive models

## Null model
### GAM 0: Null model
```{r gam0, echo=FALSE, warning=FALSE}
#### 0. GAM: Null model ####
gam_null <- gam(richness ~ 1 + s(effort, bs = "re"), 
                data = cdata, 
                family = poisson(link = "log"))
summary(gam_null)

## 2. AIC
aic_gam_null <- AIC(gam_null)
```


## GAM with additive effects
### GAM 1: rich ~ SVI + prop_veg
```{r gam1, echo=FALSE, warning=FALSE}
#### 1. GAM: rich ~ SVI + prop_veg ####
## 1. Model
gam_SVI_prop_veg <- gam(richness ~ s(SVI) + s(prop_veg) + s(effort, bs = "re"), 
                    data = cdata, 
                    family = poisson(link = "log"))
summary(gam_SVI_prop_veg)

## 2. AIC
aic_SVI_prop_veg <- AIC(gam_SVI_prop_veg)

## 3. Plot
plot(gam_SVI_prop_veg, pages = 1, residuals = TRUE, rug = TRUE)
plot_vis_gam_1 <- vis.gam(gam_SVI_prop_veg, theta = 150, n.grid = 50, lwd = 0.4)
```

```{r gam1p, include=FALSE, warning=FALSE}
## 4. Heatmap
# 4.1 Create a grid of values for SEVIn and SVI
sim_data1 <- expand.grid(prop_veg = seq(0, 1, length.out = 200),
                        SVI = seq(0, 1, length.out = 200))

# Add a fixed value for `effort` to the grid
fixed_effort <- median(cdata$effort)  # Example: using the median of `effort`

# 4.2: Use predict() to generate predictions from the model gam_SVI_prop_veg
sim_data1 <- sim_data1 %>% 
  mutate(predicted_richness = predict(gam_SVI_prop_veg, newdata = transform(sim_data1, effort = fixed_effort), type = "response"))

# 4.3: Plot the results using geom_tile() for a heatmap
plot_heatmap_1 <- ggplot(data = sim_data1, aes(x = SVI, y = prop_veg, fill = predicted_richness)) +
  geom_tile() +
  scale_fill_viridis_c(name = "Predicted richness") +
  labs(x = "SVI", y = "Proportion of vegetation") +
  theme_classic() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  ggtitle("Heatmap of model 1")

print(plot_heatmap_1)
```

### GAM 2: rich ~ SEVIo + SGVI 
```{r gam2, echo=FALSE, warning=FALSE}
#### 2. GAM: rich ~ SEVIo + SGVI ####
## 1. Model
gam_SEVIo_SGVI <- gam(richness ~ s(SEVIo) + s(SGVI) + s(effort, bs = "re"), 
                      data = cdata, 
                      family = poisson(link = "log"))
summary(gam_SEVIo_SGVI)

## 2. AIC
aic_SEVIo_SGVI <- AIC(gam_SEVIo_SGVI)

## 3. Plot
plot(gam_SEVIo_SGVI, pages = 1, residuals = TRUE, rug = TRUE)
plot_vis_gam_2 <- vis.gam(gam_SEVIo_SGVI, theta = 150, n.grid = 50, lwd = 0.4)
```

```{r gam2p, include=FALSE, warning=FALSE}
## 4. Heatmap
# 4.1 Create a grid of values for SEVIo and SGVI
sim_data2 <- expand.grid(SEVIo = seq(0, 1, length.out = 200),
                         SGVI = seq(0, 1, length.out = 200))

# Add a fixed value for `effort` to the grid
fixed_effort <- median(cdata$effort)  # Example: using the median of `effort`

# 4.2: Use predict() to generate predictions from the model gam_SEVIo_SGVI
sim_data2 <- sim_data2 %>% 
  mutate(predicted_richness = predict(gam_SEVIo_SGVI, newdata = transform(sim_data2, effort = fixed_effort), type = "response"))

# 4.3: Plot the results using geom_tile() for a heatmap
plot_heatmap_2 <- ggplot(data = sim_data2, aes(x = SEVIo, y = SGVI, fill = predicted_richness)) +
  geom_tile() +
  scale_fill_viridis_c(name = "Predicted richness") +
  labs(x = "SEVIo", y = "SGVI") +
  theme_classic() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  ggtitle("Heatmap of model 2")
```

### GAM 3: rich ~ SEVIo + SUVI
```{r gam3, echo=FALSE, warning=FALSE}
#### 3. GAM: rich ~ SEVIo + SUVI ####
## 1. Model
gam_SEVIo_SUVI <- gam(richness ~ s(SEVIo) + s(SUVI) + s(effort, bs = "re"), 
                      data = cdata, 
                      family = poisson(link = "log"))
summary(gam_SEVIo_SUVI)

## 2. AIC
aic_SEVIo_SUVI <- AIC(gam_SEVIo_SUVI)

## 3. Plot
plot(gam_SEVIo_SUVI, pages = 1, residuals = TRUE, rug = TRUE)
plot_vis_gam_3 <- vis.gam(gam_SEVIo_SUVI, theta = 150, n.grid = 50, lwd = 0.4)
```

```{r gam3p, include=FALSE, warning=FALSE}
## 4. Heatmap
# 4.1 Create a grid of values for SEVIo and SUVI
sim_data3 <- expand.grid(SEVIo = seq(0, 1, length.out = 200),
                         SUVI = seq(0, 1, length.out = 200))

# Add a fixed value for `effort` to the grid
fixed_effort <- median(cdata$effort)

# 4.2: Use predict() to generate predictions from the model gam_SEVIo_SUVI
sim_data3 <- sim_data3 %>% 
  mutate(predicted_richness = predict(gam_SEVIo_SUVI, newdata = transform(sim_data3, effort = fixed_effort), type = "response"))

# 4.3: Plot the results using geom_tile() for a heatmap
plot_heatmap_3 <- ggplot(data = sim_data3, aes(x = SEVIo, y = SUVI, fill = predicted_richness)) +
  geom_tile() +
  scale_fill_viridis_c(name = "Predicted richness") +
  labs(x = "SEVIo", y = "SUVI") +
  theme_classic() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  ggtitle("Heatmap of model 3")
```

### GAM 4: rich ~ SVI 
```{r gam4, echo=FALSE, warning=FALSE}
## 1. Model
gam_SVI <- gam(richness ~ s(SVI) + s(effort, bs = "re"), 
               data = cdata, 
               family = poisson(link = "log"))
summary(gam_SVI)

## 2. AIC
aic_SVI <- AIC(gam_SVI)

## 3. Plot
plot(gam_SVI, pages = 1, residuals = TRUE, rug = TRUE)
plot_vis_gam_4 <- vis.gam(gam_SVI, theta = 150, n.grid = 50, lwd = 0.4)
```

```{r gam4p, include=FALSE, warning=FALSE}
## 4. Heatmap
# 4.1 Create a grid of values for SVI
sim_data4 <- expand.grid(SVI = seq(0, 1, length.out = 200))

# Add a fixed value for `effort` to the grid
fixed_effort <- median(cdata$effort)

# 4.2: Use predict() to generate predictions from the model gam_SVI
sim_data4 <- sim_data4 %>% 
  mutate(predicted_richness = predict(gam_SVI, newdata = transform(sim_data4, effort = fixed_effort), type = "response"))

# 4.3: Plot the results using geom_tile() for a heatmap
plot_heatmap_4 <- ggplot(data = sim_data4, aes(x = SVI, y = predicted_richness, fill = predicted_richness)) +
  geom_tile() +
  scale_fill_viridis_c(name = "Predicted richness") +
  labs(x = "SVI", y = "Predicted richness") +
  theme_classic() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  ggtitle("Heatmap of model 4")
```

### GAM 5: rich ~ prop_veg
```{r gam5, echo=FALSE, warning=FALSE}
## 1. Model
gam_prop_veg <- gam(richness ~ s(prop_veg) + s(effort, bs = "re"), 
                    data = cdata, 
                    family = poisson(link = "log"))
summary(gam_prop_veg)

## 2. AIC
aic_prop_veg <- AIC(gam_prop_veg)

## 3. Plot
plot(gam_prop_veg, pages = 1, residuals = TRUE, rug = TRUE)
plot_vis_gam_5 <- vis.gam(gam_prop_veg, theta = 150, n.grid = 50, lwd = 0.4)
```

```{r gam5p, include=FALSE, warning=FALSE}
## 4. Heatmap
# 4.1 Create a grid of values for prop_veg
sim_data5 <- expand.grid(prop_veg = seq(0, 1, length.out = 200))

# Add a fixed value for `effort` to the grid
fixed_effort <- median(cdata$effort)

# 4.2: Use predict() to generate predictions from the model gam_prop_veg
sim_data5 <- sim_data5 %>% 
  mutate(predicted_richness = predict(gam_prop_veg, newdata = transform(sim_data5, effort = fixed_effort), type = "response"))

# 4.3: Plot the results using geom_tile() for a heatmap
plot_heatmap_5 <- ggplot(data = sim_data5, aes(x = prop_veg, y = predicted_richness, fill = predicted_richness)) +
  geom_tile() +
  scale_fill_viridis_c(name = "Predicted richness") +
  labs(x = "Proportion of vegetation", y = "Predicted richness") +
  theme_classic() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  ggtitle("Heatmap of model 5")
```


## GAM with additive effects
### GAM 6: rich ~ SVI * prop_veg
```{r gam6, echo=FALSE, warning=FALSE}
#### 1. GAM: rich ~ SVI * prop_veg ####
## 1. Model
gam_SVI_prop_veg_int <- gam(richness ~ s(SVI,prop_veg) + s(effort, bs = "re"), 
                    data = cdata, 
                    family = poisson(link = "log"))
summary(gam_SVI_prop_veg_int)

## 2. AIC
aic_SVI_prop_veg_int <- AIC(gam_SVI_prop_veg_int)

## 3. Plot
plot(gam_SVI_prop_veg_int, pages = 1, residuals = TRUE, rug = TRUE)
plot_vis_gam_6 <- vis.gam(gam_SVI_prop_veg_int, theta = 150, n.grid = 50, lwd = 0.4)
```

```{r gam6p, include=FALSE, warning=FALSE}
## 4. Heatmap
# 4.1 Create a grid of values for prop_veg and SVI
sim_data6 <- expand.grid(prop_veg = seq(0, 1, length.out = 200),
                        SVI = seq(0, 1, length.out = 200))

# Add a fixed value for `effort` to the grid
fixed_effort <- median(cdata$effort)  # Example: using the median of `effort`

# 4.2: Use predict() to generate predictions from the model gam_SVI_prop_veg
sim_data6 <- sim_data6 %>% 
  mutate(predicted_richness = predict(gam_SVI_prop_veg_int, newdata = transform(sim_data6, effort = fixed_effort), type = "response"))

# 4.3: Plot the results using geom_tile() for a heatmap
plot_heatmap_6 <- ggplot(data = sim_data6, aes(x = SVI, y = prop_veg, fill = predicted_richness)) +
  geom_tile() +
  scale_fill_viridis_c(name = "Predicted richness") +
  labs(x = "SVI", y = "Proportion of vegetation") +
  theme_classic() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  ggtitle("Heatmap of model 6")

print(plot_heatmap_6)
```

### GAM 7: rich ~ SEVIo * SGVI 
```{r gam7, echo=FALSE, warning=FALSE}
#### 7. GAM: rich ~ SEVIo * SGVI ####
## 1. Model
gam_SEVIo_SGVI_int <- gam(richness ~ s(SEVIo,SGVI) + s(effort, bs = "re"), 
                      data = cdata, 
                      family = poisson(link = "log"))
summary(gam_SEVIo_SGVI_int)

## 2. AIC
aic_SEVIo_SGVI_int <- AIC(gam_SEVIo_SGVI_int)

## 3. Plot
plot(gam_SEVIo_SGVI_int, pages = 1, residuals = TRUE, rug = TRUE)
plot_vis_gam_7 <- vis.gam(gam_SEVIo_SGVI_int, theta = 150, n.grid = 50, lwd = 0.4)
```

```{r gam7p, include=FALSE, warning=FALSE}
## 4. Heatmap
# 4.1 Create a grid of values for SEVIo and SGVI
sim_data7 <- expand.grid(SEVIo = seq(0, 1, length.out = 200),
                         SGVI = seq(0, 1, length.out = 200))

# Add a fixed value for `effort` to the grid
fixed_effort <- median(cdata$effort)  # Example: using the median of `effort`

# 4.2: Use predict() to generate predictions from the model gam_SEVIo_SGVI
sim_data7 <- sim_data7 %>% 
  mutate(predicted_richness = predict(gam_SEVIo_SGVI_int, newdata = transform(sim_data7, effort = fixed_effort), type = "response"))

# 4.3: Plot the results using geom_tile() for a heatmap
plot_heatmap_7 <- ggplot(data = sim_data7, aes(x = SEVIo, y = SGVI, fill = predicted_richness)) +
  geom_tile() +
  scale_fill_viridis_c(name = "Predicted richness") +
  labs(x = "SEVIo", y = "SGVI") +
  theme_classic() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  ggtitle("Heatmap of model 7")
```

### GAM 8: rich ~ SEVIo * SUVI
```{r gam8, echo=FALSE, warning=FALSE}
#### 3. GAM: rich ~ SEVIo * SUVI ####
## 1. Model
gam_SEVIo_SUVI_int <- gam(richness ~ s(SEVIo,SUVI) + s(effort, bs = "re"), 
                      data = cdata, 
                      family = poisson(link = "log"))
summary(gam_SEVIo_SUVI_int)

## 2. AIC
aic_SEVIo_SUVI_int <- AIC(gam_SEVIo_SUVI_int)

## 3. Plot
plot(gam_SEVIo_SUVI_int, pages = 1, residuals = TRUE, rug = TRUE)
plot_vis_gam_8 <- vis.gam(gam_SEVIo_SUVI_int, theta = 150, n.grid = 50, lwd = 0.4)
```

```{r gam8p, include=FALSE, warning=FALSE}
## 4. Heatmap
# 4.1 Create a grid of values for SEVIo and SUVI
sim_data8 <- expand.grid(SEVIo = seq(0, 1, length.out = 200),
                         SUVI = seq(0, 1, length.out = 200))

# Add a fixed value for `effort` to the grid
fixed_effort <- median(cdata$effort)

# 4.2: Use predict() to generate predictions from the model gam_SEVIo_SUVI
sim_data8 <- sim_data8 %>% 
  mutate(predicted_richness = predict(gam_SEVIo_SUVI_int, newdata = transform(sim_data8, effort = fixed_effort), type = "response"))

# 4.3: Plot the results using geom_tile() for a heatmap
plot_heatmap_8 <- ggplot(data = sim_data8, aes(x = SEVIo, y = SUVI, fill = predicted_richness)) +
  geom_tile() +
  scale_fill_viridis_c(name = "Predicted richness") +
  labs(x = "SEVIo", y = "SUVI") +
  theme_classic() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  ggtitle("Heatmap of model 8")
```


## Comparing GAM models

```{r compar, echo=FALSE, warning=FALSE}
# Store model names and AIC values in a data frame
aic_values <- data.frame(
  Model = c("Model 1 (SVI + prop_veg)", 
            "Model 2 (SEVIo + SGVI)", 
            "Model 3 (SEVIo + SUVI)", 
            "Model 4 (SVI)", 
            "Model 5 (prop_veg)",
            "Model 6 (SVI * prop_veg)", 
            "Model 7 (SEVIo * SGVI)", 
            "Model 8 (SEVIo * SUVI)",
            "Null Model"),
  AIC = c(aic_SVI_prop_veg, 
          aic_SEVIo_SGVI, 
          aic_SEVIo_SUVI, 
          aic_SVI, 
          aic_prop_veg,
          aic_SVI_prop_veg_int, 
          aic_SEVIo_SGVI_int, 
          aic_SEVIo_SUVI_int,
          aic_gam_null)
)

# Sort by AIC
aic_values_sorted <- aic_values[order(aic_values$AIC), ]
print(aic_values_sorted)
```

```{r heatmap, echo=FALSE, warning=FALSE}
plot_heatmap_3
plot_heatmap_8
plot_heatmap_2
plot_heatmap_7
plot_heatmap_1
plot_heatmap_6
```




